import groovy.json.JsonSlurper
import groovy.json.JsonSlurperClassic
@NonCPS
def jsonParse(def json) {
    new groovy.json.JsonSlurperClassic().parseText(json) // 重点
}

pipeline{
    agent any
    stages{
        stage('TEST'){
            steps{
                sh "gradle -version"
                sh "pwd"
            }
        }
        stage('Get'){
            steps{
                script{
                    def branch = "${GIT_BRANCH}"
                    def url = "https://cloudapi.bytedance.net/faas/services/ttwcxk/invoke/jenkins_apk_builder?branch="+branch
                    def code =sh(script:"curl ${url} > index.json",returnStatus:true)
                    if(code == 0){
                        def result =sh(script:"cat index.json",returnStdout: true)
                        //def result_json = new JsonSlurperClassic()
                        def result_map = jsonParse(result)

                        echo "结果code："+result_map.code
                        echo "结果msg："+result_map.msg
                        sh "pwd"
                    }else{
                        sh 'exit 1'
                    }
                }
            }
        }
    }
}